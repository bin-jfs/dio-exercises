#!/usr/bin/env python3

from cryptography.fernet import Fernet
# Importa a classe Fernet, que permite realizar criptografia e descriptografia simétrica.

import os
# Importa o módulo os para manipulação de arquivos e diretórios.


def decrypt_file(file_name, key):
    # Função responsável por descriptografar um arquivo usando a chave fornecida.
    fernet = Fernet(key)  # Inicializa o objeto Fernet com a chave.
    # Abre o arquivo criptografado em modo leitura binária.
    with open(file_name, 'rb') as encrypted_file:
        encrypted = encrypted_file.read()  # Lê o conteúdo criptografado.
    decrypted = fernet.decrypt(encrypted)  # Descriptografa o conteúdo.
    # Reabre o arquivo em modo escrita binária.
    with open(file_name, 'wb') as decrypted_file:
        # Sobrescreve com o conteúdo original (descriptografado).
        decrypted_file.write(decrypted)


if __name__ == "__main__":
    # Ponto de entrada principal do script.
    try:
        if not os.path.exists("key.txt"):
            # Verifica se o arquivo de chave existe.
            print("O arquivo de chave não foi encontrado!!!")
            exit(1)  # Encerra o programa com código de erro.
        with open("key.txt", "rb") as key_file:
            # Abre o arquivo de chave em modo leitura binária.
            key = key_file.read()  # Lê a chave de criptografia.
        for files in os.listdir():
            # Itera sobre todos os arquivos do diretório atual.
            if files.lower() in ["key.txt", "requirements.txt"] \
               or files.lower().endswith((".py", ".exe")) \
               or os.path.isdir(files):
                # Ignora arquivos críticos (como a chave, scripts Python, executáveis e diretórios).
                continue
            # Exibe mensagem indicando qual arquivo está sendo processado.
            print(f"Descriptografando {files}...")
            # Chama a função para descriptografar o arquivo.
            decrypt_file(files, key)
        print("\nSeus arquivos foram descriptografados com sucesso!")
        # Mensagem final indicando que o processo terminou sem erros.
    except Exception as e:
        # Captura qualquer erro que ocorra durante a execução.
        print(f"\nOcorreu um erro durante a descriptografia: {e}")
        # Exibe a mensagem de erro para o usuário.
